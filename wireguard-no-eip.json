{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Set up a wireguard VPN.",
    "Metadata": {},
    "Parameters": {
        "LatestAmiId": {
            "Description": "Grab the latest AL2 AMI",
            "Default": "/aws/service/ami-amazon-linux-latest/al2023-ami-minimal-kernel-default-x86_64",
            "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
        },
        "InstanceType": {
            "Default": "t2.micro",
            "Description": "Instance type",
            "Type": "String"
        },
        "ServerTunnelSubnet": {
            "Default": "10.10.10.1/24",
            "Description": "The network available to the tunnel.",
            "Type": "String"
        },
        "PeerTunnelSubnet": {
            "Default": "10.10.10.2/32",
            "Description": "The possible tunnel peers. One is the default",
            "Type": "String"
        },
        "VpnSecurityGroupID": {
            "Description": "The VPC default Security GroupID",
            "Type": "AWS::EC2::SecurityGroup::Id"
        },
        "AssociateEip": {
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "true",
            "Description": "This is to associate with an already created/exported EIP. Should be true unless testing.",
            "Type": "String"
        },
        "PublicKey": {
            "Type": "String",
            "Description": "The (optional) public SSH key for EC2 key pair",
            "Default": ""
        },
        "PublicKeyName": {
            "Type": "String",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance.",
            "Default": "wgPublicKey"
        }
    },
    "Mappings": {},
    "Conditions": {
        "CreateAssociateEip": {
            "Fn::Equals": [
                {
                    "Ref": "AssociateEip"
                },
                "true"
            ]
        },
        "IsPublicKeyProvided": {
            "Fn::Not": [
                {
                "Fn::Equals": [
                    {
                    "Ref": "PublicKey"
                    },
                    ""
                ]
                }
            ]
        }
    },
    "Resources": {
        "MyKeyPair": {
            "Type": "AWS::EC2::KeyPair",
            "Condition": "IsPublicKeyProvided",
            "Properties": {
                "KeyName": {
                    "Ref": "PublicKeyName"
                },
                "PublicKeyMaterial": {
                    "Ref": "PublicKey"
                }
            }
        },
        "VpnSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "VPN security group created by cloudformation",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "udp",
                        "FromPort": 51820,
                        "ToPort": 51820,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "VpnInstance": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "packages": {
                            "dnf": {
                                "wireguard-tools": [],
                                "kernel-devel": [],
                                "aws-cfn-bootstrap": [],
                                "nftables": [],
                                "iptables-nft": [],
                                "amazon-cloudwatch-agent": [],
                                "cronie": [],
                                "python-boto3": []
                            }
                        },
                        "files": {
                            "/etc/wireguard/wg0.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[Interface]\n",
                                            "Address = ",
                                            {
                                                "Ref": "ServerTunnelSubnet"
                                            },
                                            "\n",
                                            "PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o enX0 -j MASQUERADE\n",
                                            "PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o enX0 -j MASQUERADE\n",
                                            "ListenPort = 51820\n",
                                            "PrivateKey = fakeServerPrivateKey\n",
                                            "SaveConfig = true\n",
                                            "\n",
                                            "[Peer]\n",
                                            "PublicKey = fakePeerPublicKey\n",
                                            "AllowedIPs = ",
                                            {
                                                "Ref": "PeerTunnelSubnet"
                                            },
                                            "\n"
                                        ]
                                    ]
                                },
                                "mode": "000600",
                                "owner": "root",
                                "group": "root"
                            },
                            "/tmp/wg0-client.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[Interface]\n",
                                            "Address = ",
                                            {
                                                "Ref": "PeerTunnelSubnet"
                                            },
                                            "\n",
                                            "DNS = 1.1.1.1\n",
                                            "PrivateKey = fakePeerPrivateKey\n",
                                            "\n",
                                            "[Peer]\n",
                                            "PublicKey = fakeServerPublicKey\n",
                                            "AllowedIPs = 0.0.0.0/0\n",
                                            "Endpoint = ",
                                            {
                                                "Fn::ImportValue": "WireguardEIPAddress"
                                            },
                                            ":51820\n"
                                        ]
                                    ]
                                },
                                "mode": "000600",
                                "owner": "root",
                                "group": "root"
                            },
                            "/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d/wg.json": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "{\n",
                                            "  \"agent\": {\n",
                                            "    \"metrics_collection_interval\": 60,\n",
                                            "    \"run_as_user\": \"root\"\n",
                                            "  },\n",
                                            "  \"logs\": {\n",
                                            "    \"logs_collected\": {\n",
                                            "      \"files\": {\n",
                                            "        \"collect_list\": [\n",
                                            "          {\n",
                                            "            \"file_path\": \"/var/log/syslog\",\n",
                                            "            \"log_stream_name\": \"${aws:InstanceId}/syslog\",\n",
                                            "            \"log_group_name\": \"Journald\"\n",
                                            "          },\n",
                                            "          {\n",
                                            "            \"file_path\": \"/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log\",\n",
                                            "            \"log_group_name\": \"WgSyslog\",\n",
                                            "            \"log_stream_name\": \"${aws:InstanceId}/syslog\",\n",
                                            "            \"timezone\": \"UTC\"\n",
                                            "          }\n",
                                            "        ]\n",
                                            "      }\n",
                                            "    }\n",
                                            "  },\n",
                                            "  \"metrics\": {\n",
                                            "    \"namespace\": \"Production/WireGuard\",\n",
                                            "    \"metrics_collected\": {\n",
                                            "      \"net\": {\n",
                                            "        \"measurement\": [\n",
                                            "          \"bytes_sent\",\n",
                                            "          \"bytes_recv\"\n",
                                            "        ],\n",
                                            "        \"metrics_collection_interval\": 60,\n",
                                            "        \"resources\": [\n",
                                            "          \"wg0\"\n",
                                            "        ]\n",
                                            "      }\n",
                                            "    },\n",
                                            "    \"append_dimensions\": {\n",
                                            "      \"InstanceId\": \"${aws:InstanceId}\",\n",
                                            "      \"InstanceType\": \"${aws:InstanceType}\"\n",
                                            "    }\n",
                                            "  }\n",
                                            "}\n"                                        ]
                                    ]
                                },
                                "mode": "000644",
                                "owner": "root",
                                "group": "root"
                            },
                            "/usr/local/bin/wireguard-cloudwatch-metrics.py": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/env python3\n",
                                            "import re\n",
                                            "import subprocess\n",
                                            "\n",
                                            "import boto3\n",
                                            "import requests\n",
                                            "\n",
                                            "# Define the CloudWatch namespace\n",
                                            "CLOUDWATCH_NAMESPACE = 'Production/WireGuard'\n",
                                            "\n",
                                            "def get_instance_region():\n",
                                            "    \"\"\"Retrieve the instance region using IMDSv2.\"\"\"\n",
                                            "    token_url = \"http://169.254.169.254/latest/api/token\"\n",
                                            "    metadata_url = \"http://169.254.169.254/latest/meta-data/placement/region\"\n",
                                            "\n",
                                            "    # Step 1: Retrieve the token\n",
                                            "    try:\n",
                                            "        # Fetch the token\n",
                                            "        token_response = requests.put(token_url, headers={\"X-aws-ec2-metadata-token-ttl-seconds\": \"21600\"})\n",
                                            "        token_response.raise_for_status()  # Raise an error for bad responses\n",
                                            "        token = token_response.text\n",
                                            "    except requests.RequestException as e:\n",
                                            "        print(f\"Error retrieving token for IMDS: {e}\")\n",
                                            "        return None\n",
                                            "\n",
                                            "    # Step 2: Use the token to access the metadata\n",
                                            "    try:\n",
                                            "        response = requests.get(metadata_url, headers={\"X-aws-ec2-metadata-token\": token})\n",
                                            "        response.raise_for_status()  # Raise an error for bad responses\n",
                                            "        region = response.text\n",
                                            "        return region\n",
                                            "    except requests.RequestException as e:\n",
                                            "        print(f\"Error retrieving instance region: {e}\")\n",
                                            "        return None\n",
                                            "\n",
                                            "def clean_peer_id(peer_id):\n",
                                            "    return peer_id\n",
                                            "    # Replace any non-alphanumeric character with 'Z' and make uppercase\n",
                                            "    #return re.sub(r'[^a-zA-Z0-9]', 'Z', peer_id).upper()\n",
                                            "\n",
                                            "def get_wireguard_metrics():\n",
                                            "    result = subprocess.run(['wg', 'show', 'all', 'dump'], stdout=subprocess.PIPE, text=True)\n",
                                            "    metrics = []\n",
                                            "\n",
                                            "    for rownum, line in enumerate(result.stdout.strip().splitlines()):\n",
                                            "        columns = line.split('\t')\n",
                                            "        # Skip the first line and adjust the columns as per your requirements\n",
                                            "        if len(columns) >= 5 and rownum > 0:\n",
                                            "            # Subsequent  lines are printed for each peer and contain\n",
                                            "            #  in order separated by tab: interface[0],\n",
                                            "            #  public-key[1], preshared-key[2], endpoint[3],\n",
                                            "            #  allowed-ips[4], latest-handshake[5], \n",
                                            "            #  transfer-rx[6], transfer-tx[7], persistent-keepalive[7]\n",
                                            "            del columns[4]  # deletes allowed-ips\n",
                                            "            del columns[3]  # deletes endpoint\n",
                                            "            del columns[2]  # deletes preshared-key\n",
                                            "            \n",
                                            "            # Cleaned peer ID\n",
                                            "            peer_id = clean_peer_id(columns[1])[:16]\n",
                                            "            last_handshake, received_bytes, transmitted_bytes = columns[1:4]\n",
                                            "            \n",
                                            "            # Create metric data to send\n",
                                            "            metrics.append({\n",
                                            "                'MetricName': 'LastHandshake',\n",
                                            "                'Value': float(last_handshake) if last_handshake.isdigit() else 0,  \n",
                                            "                'Unit': 'Seconds',\n",
                                            "                'Dimensions': [{'Name': 'ClientID', 'Value': peer_id}]\n",
                                            "            })\n",
                                            "            metrics.append({\n",
                                            "                'MetricName': 'ReceivedBytes',\n",
                                            "                'Value': float(received_bytes) if received_bytes.isdigit() else 0,\n",
                                            "                'Unit': 'Bytes',\n",
                                            "                'Dimensions': [{'Name': 'ClientID', 'Value': peer_id}]\n",
                                            "            })\n",
                                            "            metrics.append({\n",
                                            "                'MetricName': 'TransmittedBytes',\n",
                                            "                'Value': float(transmitted_bytes) if transmitted_bytes.isdigit() else 0,\n",
                                            "                'Unit': 'Bytes',\n",
                                            "                'Dimensions': [{'Name': 'ClientID', 'Value': peer_id}]\n",
                                            "            })\n",
                                            "\n",
                                            "    return metrics\n",
                                            "\n",
                                            "def send_metrics_to_cloudwatch(metrics, region):\n",
                                            "    # Create the CloudWatch client with the specified region\n",
                                            "    cloudwatch = boto3.client('cloudwatch', region_name=region)\n",
                                            "\n",
                                            "    # Batch metrics in groups of 20 (max allowed per PutMetricData call)\n",
                                            "    for i in range(0, len(metrics), 20):\n",
                                            "        cloudwatch.put_metric_data(\n",
                                            "            Namespace=CLOUDWATCH_NAMESPACE,\n",
                                            "            MetricData=metrics[i:i+20]  # Send a chunk of up to 20 metrics\n",
                                            "        )\n",
                                            "\n",
                                            "if __name__ == \"__main__\":\n",
                                            "    region = get_instance_region()\n",
                                            "    if region:  # Proceed only if region is successfully obtained\n",
                                            "        metrics = get_wireguard_metrics()\n",
                                            "        send_metrics_to_cloudwatch(metrics, region)\n",
                                            "    else:\n",
                                            "        print(\"Failed to retrieve the instance region, exiting.\")\n"                                        ]
                                    ]
                                },
                                "mode": "000700",
                                "owner": "root",
                                "group": "root"
                            },
                            "/etc/nftables-ignore.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "table inet filter {\n",
                                            "    chain input {\n",
                                            "        type filter hook input priority 0; policy drop;  # Default policy to drop\n",
                                            "        # Allow established and related connections\n",
                                            "        ct state established,related accept\n",
                                            "        # Allow localhost traffic\n",
                                            "        ip saddr 127.0.0.1 accept\n",
                                            "        # Log all incoming traffic\n",
                                            "        log prefix \"IN:\" group 0\n",
                                            "        # Allow WireGuard traffic on UDP port 51820\n",
                                            "        udp dport 51820 accept\n",
                                            "        # Allow ICMP (ping) for troubleshooting\n",
                                            "        icmp type echo-request accept\n",
                                            "        icmp type echo-reply accept\n",
                                            "        # Log and drop all other packets\n",
                                            "        log prefix \"DROP: \" drop\n",
                                            "        # Reject all other connections with an ICMP port-unreachable message\n",
                                            "        reject with icmp type port-unreachable\n",
                                            "    }\n",
                                            "    chain forward {\n",
                                            "        type filter hook forward priority 0; policy drop;  # Default policy to drop\n",
                                            "        # Allow forwarding of WireGuard packets\n",
                                            "        iifname \"wg0\" accept\n",
                                            "        oifname \"wg0\" accept\n",
                                            "    }\n",
                                            "    chain output {\n",
                                            "        type filter hook output priority 0; policy accept;  # Allow all outgoing connections by default\n",
                                            "        # Log all outgoing traffic\n",
                                            "        log prefix \"OUT:\" group 0\n",
                                            "    }\n",
                                            "}\n"                                            
                                        ]
                                    ]

                                },
                                "mode": "000600",
                                "owner": "root",
                                "group": "root"
                            },
                            "/etc/systemd/system/wg_metrics.service": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[Unit]\n",
                                            "Description=WireGuard Metrics\n\n",
                                            "[Service]\n",
                                            "ExecStart=/usr/bin/python3 /usr/local/bin/wireguard-cloudwatch-metrics.py\n",
                                            "WorkingDirectory=/root\n",
                                            "StandardOutput=journal\n",
                                            "StandardError=journal\n",
                                            "User=root\n",
                                            "Group=root\n\n",
                                            "[Install]\n",
                                            "WantedBy=multi-user.target\n"
                                        ]
                                    ]
                                }
                            },
                            "/etc/systemd/system/wg_metrics.timer": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[Unit]\n",
                                            "Description=WireGuard Metric Timer\n\n",
                                            "[Timer]\n",
                                            "OnActiveSec=1min\n",
                                            "OnUnitActiveSec=1min\n",
                                            "Unit=wg_metrics.service\n\n",
                                            "[Install]\n",
                                            "WantedBy=timers.target\n"
                                        ]
                                    ]
                                }
                            }
                        }
                    },
                    "commands": {
                      "01_start_agent": {
                        "command": "systemctl restart amazon-cloudwatch-agent"
                      }, 
                      "02_enable_wg_service": {
                        "command": "systemctl enable wg_metrics.service"
                      },
                      "03_enable_wg_timer": {
                        "command": "systemctl enable --now wg_metrics.timer"
                      },
                      "04_wg_service": {
                        "command": "systemctl enable --now wg-quick@wg0"
                      }, 
                      "05_wg_logging": {
                        "command": "echo module wireguard +p > /sys/kernel/debug/dynamic_debug/control"
                      }
                    }
                }
            },
            "Properties": {
                "ImageId": {
                    "Ref": "LatestAmiId"
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "KeyName": {
                    "Fn::If": [
                        "IsPublicKeyProvided",
                        {
                        "Ref": "PublicKeyName"
                        },
                        { "Ref": "AWS::NoValue" }
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "WgEc2IamProfile"
                },
                "BlockDeviceMappings": [
                   {
                      "DeviceName": "/dev/xvda",
                      "Ebs": {
                         "VolumeSize": "60"
                      }
                  }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -e\n",
                                "echo \"INFO: Getting system updates\"\n",
                                "dnf update -y -qq\n",
                                "# Install aws-cfn-bootstrap\n",
                                "time dnf install -qqq -y aws-cfn-bootstrap wireguard-tools iptables-nft kernel-devel rsyslog amazon-cloudwatch-agent python3-boto3\n",
                                "# Confirm cfn-init installation\n",
                                "if [ ! -f /usr/bin/cfn-init ]; then\n",
                                "  echo 'ERROR: cfn-init not installed!';\n",
                                "  exit 1;\n",
                                "fi\n",
                                "\n",
                                "# Configure rsyslog to receive logs from journald\n",
                                "echo 'module(load=\"imjournal\" stateFile=\"imjournal.state\")' >> /etc/rsyslog.conf\n",
                                "echo '*.* /var/log/syslog' >> /etc/rsyslog.conf\n",
                                "systemctl restart rsyslog\n",
                                "\n",
                                "# Configure CloudWatch Agent\n",
                                "cat > /opt/aws/amazon-cloudwatch-agent/bin/config.json << EOL\n",
                                "{\n",
                                "  \"agent\": {\n",
                                "    \"metrics_collection_interval\": 60,\n",
                                "    \"run_as_user\": \"root\"\n",
                                "  },\n",
                                "  \"logs\": {\n",
                                "    \"logs_collected\": {\n",
                                "      \"files\": {\n",
                                "        \"collect_list\": [\n",
                                "          {\n",
                                "            \"file_path\": \"/var/log/syslog\",\n",
                                "            \"log_group_name\": \"WgSyslog\",\n",
                                "            \"log_stream_name\": \"{instance_id}\"\n",
                                "          }\n",
                                "        ]\n",
                                "      }\n",
                                "    }\n",
                                "  }\n",
                                "}\n",
                                "EOL\n",
                                "\n",
                                "# Start CloudWatch Agent\n",
                                "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -s -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json\n",
                                "\n",
                        
                                "# Install the files and packages from the metadata\n",
                                "/usr/bin/cfn-init -v ",
                                "         --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "         --resource VpnInstance     ",
                                "         --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "echo \"INFO: Enabling IPv4/IPv4 forwarding\"\n",
                                "echo \"net.ipv4.ip_forward = 1\" >> /etc/sysctl.conf\n",
                                "echo \"net.ipv6.conf.all.forwarding = 1\" >> /etc/sysctl.conf\n",
                                "sysctl -p\n",
                                "echo \"INFO: Generating keys and puting them in configs\"\n",
                                "SERVER_PRIVATE_KEY=$(wg genkey)\n",
                                "SERVER_PUBLIC_KEY=$(echo $SERVER_PRIVATE_KEY | wg pubkey)\n",
                                "sed -i \"s|fakeServerPrivateKey|$SERVER_PRIVATE_KEY|\" /etc/wireguard/wg0.conf\n",
                                "sed -i \"s|fakeServerPublicKey|$SERVER_PUBLIC_KEY|\" /tmp/wg0-client.conf\n",
                                "CLIENT_PRIVATE_KEY=$(wg genkey)\n",
                                "CLIENT_PUBLIC_KEY=$(echo $CLIENT_PRIVATE_KEY | wg pubkey)\n",
                                "sed -i \"s|fakePeerPublicKey|$CLIENT_PUBLIC_KEY|\" /etc/wireguard/wg0.conf\n",
                                "sed -i \"s|fakePeerPrivateKey|$CLIENT_PRIVATE_KEY|\" /tmp/wg0-client.conf\n",
                                "\n",
                                "echo \"INFO: Creating the AWS Parameter alias/aws/ssm\"\n",
                                "aws ssm put-parameter",
                                "    --name \"ClientConfig\"",
                                "    --type \"SecureString\"",
                                "    --key-id alias/aws/ssm",
                                "    --overwrite",
                                "    --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "    --value \"$(cat /tmp/wg0-client.conf)\" \n",
                                "echo \"INFO: Enabling wireguard on restart\"\n",
                                "sudo systemctl enable wg-quick@wg0.service\n",
                                "echo \"INFO: Deleting client WireGuard keys from the system\"\n",
                                "# Erase init log to remove key, may need to comment out to trouble shoot\n",
                                "rm -f /tmp/wg0-client.conf\n",
                                "cat /dev/null > /var/log/cloud-init-output.log\n",
                                "echo \"INFO: Reboot needed to force kernel header to take effect\"\n",
                                "reboot\n"
                            ]
                        ]
                    }
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "VpnSecurityGroupID"
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "VpnSecurityGroup"
                    }
                ],
                "Tags": [
                    { "Key": "project", "Value": "wireguard" },
                    { "Key": "Name", "Value": "wg1" }
                ]
            }
        },
        "WireguardVpnEipAsso": {
            "Type": "AWS::EC2::EIPAssociation",
            "Condition": "CreateAssociateEip",
            "Properties": {
                "AllocationId": {
                    "Fn::ImportValue": "WireguardEIPAllocationId"
                },
                "InstanceId": {
                    "Ref": "VpnInstance"
                }
            }
        },
        "WgEc2IamRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/"
            }
        },
        "WgEc2IamProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "WgEc2IamRole"
                    }
                ]
            }
        },
        "WgEc2IamPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "ssm:PutParameter"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "kms:Encrypt"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:WgSyslog:*"
                                }
                            ]
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "cloudwatch:PutMetricData"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "PolicyName": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            {
                                "Ref": "AWS::Region"
                            }
                        ]
                    ]
                },
                "Roles": [
                    {
                        "Ref": "WgEc2IamRole"
                    }
                ]
            }
        },
        "SyslogLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": "WgSyslog",
                "RetentionInDays": 3
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
              "Roles": [
                { "Ref": "EC2Role" }
              ]
            }
          },
          "EC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
              "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": "ec2.amazonaws.com"
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
              "Policies": [
                {
                  "PolicyName": "CloudWatchAgentPolicy",
                  "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": [
                          "cloudwatch:PutMetricData",
                          "logs:CreateLogGroup",
                          "logs:CreateLogStream",
                          "logs:PutLogEvents"
                        ],
                        "Resource": "*"
                      }
                    ]
                  }
                }
              ]
            }
        }
    },
    "Outputs": {
        "VpnInstanceId": {
            "Description": "ID of VPN Instance",
            "Value": {
                "Ref": "VpnInstance"
            }
        },
        "WgClientConfig": {
            "Description": "Click to access Wireguard Client Config",
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        "https://",
                        {
                            "Ref": "AWS::Region"
                        },
                        ".console.aws.amazon.com/systems-manager/parameters/ClientConfig/description?region=",
                        {
                            "Ref": "AWS::Region"
                        }
                    ]
                ]
            }
        }
    }
}
